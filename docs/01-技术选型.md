# 技术选型文档

## 整体技术架构

### 架构模式：Hybrid Architecture

采用 **C++ 原生核心 + WebView2 嵌入式前端** 的混合架构模式：

```
┌─────────────────────────────────────────┐
│         前端层 (Vue 3)                   │
│  - UI 组件                               │
│  - 状态管理                              │
│  - 用户交互                              │
└─────────────────┬───────────────────────┘
                  │ WebView2 Bridge
┌─────────────────▼───────────────────────┐
│      通信层 (IPC)                        │
│  - JSON-RPC 2.0                         │
│  - WebSocket (实时通信)                 │
│  - Shared Memory (高性能数据传输)       │
└─────────────────┬───────────────────────┘
                  │
┌─────────────────▼───────────────────────┐
│      C++ 核心引擎                        │
│  - 窗口管理                              │
│  - 系统调用                              │
│  - 性能关键路径                          │
└──────────────────────────────────────────┘
```

## 后端技术栈

### 1. 核心语言：C++20

**选择理由**：
- 系统级编程能力
- 极致性能
- 直接访问 Windows API
- 零运行时开销

**标准库使用**：
- `<thread>`, `<mutex>`, `<atomic>`: 并发控制
- `<filesystem>`: 文件系统操作
- `<memory>`: 智能指针
- `<chrono>`: 时间处理

### 2. 窗口系统：Win32 API + Direct2D

**Win32 API 核心功能**：
```cpp
// 窗口层级控制
SetWindowPos()
SetLayeredWindowAttributes()
DwmSetWindowAttribute()

// 窗口样式
WS_EX_LAYERED      // 分层窗口（透明效果）
WS_EX_TOPMOST      // 置顶
WS_EX_TOOLWINDOW   // 工具窗口（不在任务栏显示）
WS_EX_NOACTIVATE   // 不激活窗口
```

**Direct2D 渲染**：
- 硬件加速 2D 图形
- 高性能动画
- 抗锯齿渲染
- 低 CPU 占用

**替代方案对比**：

| 技术 | 优势 | 劣势 | 是否采用 |
|------|------|------|---------|
| Win32 + Direct2D | 原生、高性能、完全控制 | 开发复杂度高 | ✅ 采用 |
| Qt | 跨平台、功能丰富 | 体积大(100MB+) | ❌ 不符合轻量要求 |
| WinUI 3 | 现代化、官方支持 | 运行时依赖大 | ❌ 体积问题 |

### 3. WebView 引擎：Microsoft Edge WebView2

**选择理由**：
- Windows 10/11 原生集成
- 基于 Chromium，性能优秀
- 体积小（运行时系统提供）
- C++ 原生 API

**核心 API**：
```cpp
#include <WebView2.h>

// 核心接口
ICoreWebView2Controller
ICoreWebView2
ICoreWebView2Settings

// 关键功能
PostWebMessageAsJson()    // C++ -> JS
add_WebMessageReceived()  // JS -> C++
ExecuteScript()           // 执行 JS 代码
```

### 4. 视频解码：FFmpeg（精简构建）

**功能**：
- 动态壁纸视频解码
- 支持主流格式：MP4, WebM, AVI

**精简策略**：
```bash
# 仅保留必要的解码器和格式
./configure \
  --disable-everything \
  --enable-decoder=h264,hevc,vp9,vp8 \
  --enable-demuxer=mp4,matroska \
  --enable-protocol=file \
  --disable-doc \
  --disable-debug
```

**预期体积**：< 10MB

### 5. 图形库：DirectX 11

**用途**：
- 动态壁纸渲染
- 桌宠模型渲染
- GPU 加速特效

**关键组件**：
- `D3D11`: 核心渲染 API
- `DXGI`: 显示器管理
- `Direct2D`: 2D 图形（Dock 栏）
- `DirectWrite`: 文本渲染

### 6. 依赖库

| 库名 | 版本 | 用途 | 许可证 |
|------|------|------|--------|
| **nlohmann/json** | 3.11.2 | JSON 解析 | MIT |
| **spdlog** | 1.12.0 | 日志系统 | MIT |
| **websocketpp** | 0.8.2 | WebSocket 服务器 | BSD |
| **SQLite** | 3.43.0 | 本地数据库 | Public Domain |
| **libcurl** | 8.4.0 | HTTP 客户端（更新检查） | MIT |
| **Boost.Asio** | 1.83.0 | 异步 I/O | Boost |
| **stb_image** | 2.28 | 图片加载 | MIT/Public Domain |

**依赖管理**：使用 **vcpkg**

```bash
vcpkg install nlohmann-json spdlog websocketpp sqlite3 curl boost-asio
```

## 前端技术栈

### 1. 核心框架：Vue 3

**选择理由**：
- 轻量级（33KB gzip）
- Composition API 适合复杂状态管理
- 优秀的 TypeScript 支持
- 虚拟 DOM 性能优秀

**关键特性使用**：
```typescript
// Composition API
import { ref, computed, onMounted } from 'vue'

// Teleport（弹窗管理）
<Teleport to="body">
  <Modal />
</Teleport>

// KeepAlive（组件缓存）
<KeepAlive>
  <component :is="currentView" />
</KeepAlive>
```

### 2. 状态管理：Pinia

**优势**：
- Vue 3 官方推荐
- TypeScript 完美支持
- 模块化设计
- DevTools 集成

**Store 结构**：
```typescript
// stores/dock.ts
export const useDockStore = defineStore('dock', {
  state: () => ({
    apps: [] as DockApp[],
    position: 'bottom' as DockPosition,
    autoHide: false
  }),
  actions: {
    async addApp(app: DockApp) { },
    async removeApp(id: string) { }
  }
})
```

### 3. UI 组件库：自定义组件 + Headless UI

**策略**：不使用重量级组件库（如 Element Plus），自行开发

**设计系统**：
```
components/
├── base/               # 基础组件
│   ├── Button.vue
│   ├── Input.vue
│   ├── Switch.vue
│   └── Slider.vue
├── dock/              # Dock 专用组件
│   ├── DockContainer.vue
│   ├── DockItem.vue
│   └── DockSeparator.vue
├── wallpaper/         # 壁纸组件
│   ├── WallpaperGrid.vue
│   ├── WallpaperPreview.vue
│   └── WallpaperPlayer.vue
└── pet/               # 桌宠组件
    ├── PetCanvas.vue
    └── PetController.vue
```

**Headless UI** 用于：
- 下拉菜单逻辑
- 模态框管理
- 标签页切换

### 4. 动画库：自定义 + GSAP

**策略**：
- 简单动画：CSS Transitions + Vue Transition
- 复杂动画：GSAP (GreenSock)

**GSAP 使用场景**：
```typescript
// Dock 图标放大动画
gsap.to(iconRef.value, {
  scale: 1.5,
  duration: 0.3,
  ease: 'back.out(1.7)'
})

// 桌宠移动动画
gsap.to(petRef.value, {
  x: targetX,
  y: targetY,
  duration: 2,
  ease: 'power1.inOut'
})
```

### 5. 构建工具：Vite 5

**优势**：
- 极快的冷启动
- 热模块替换 (HMR)
- 优化的生产构建
- 原生 ESM 支持

**配置重点**：
```typescript
// vite.config.ts
export default defineConfig({
  base: './',  // 相对路径（嵌入 WebView2）
  build: {
    outDir: '../resources/web',
    target: 'es2020',
    minify: 'terser',
    rollupOptions: {
      output: {
        manualChunks: {
          'vendor': ['vue', 'pinia'],
          'gsap': ['gsap']
        }
      }
    }
  },
  server: {
    port: 5173,
    strictPort: true
  }
})
```

### 6. 类型系统：TypeScript 5.2

**配置**：
```json
{
  "compilerOptions": {
    "target": "ES2020",
    "module": "ESNext",
    "moduleResolution": "bundler",
    "strict": true,
    "jsx": "preserve",
    "sourceMap": true,
    "resolveJsonModule": true,
    "esModuleInterop": true,
    "lib": ["ES2020", "DOM", "DOM.Iterable"],
    "types": ["vite/client"],
    "paths": {
      "@/*": ["./src/*"]
    }
  }
}
```

## 进程间通信 (IPC) 设计

### 1. 主要通信方式

#### 方案 A：JSON-RPC 2.0 over WebView2 (采用)

**C++ -> JavaScript**：
```cpp
// C++ 端
std::string json = R"({
  "jsonrpc": "2.0",
  "method": "dock.updateApps",
  "params": {...},
  "id": 1
})";
webView->PostWebMessageAsJson(json.c_str());
```

**JavaScript -> C++**：
```typescript
// TypeScript 端
window.chrome.webview.postMessage({
  jsonrpc: '2.0',
  method: 'wallpaper.setActive',
  params: { id: '123' },
  id: 2
})

// C++ 接收
EventRegistrationToken token;
webView->add_WebMessageReceived(
  Callback<ICoreWebView2WebMessageReceivedEventHandler>(
    [](ICoreWebView2*, ICoreWebView2WebMessageReceivedEventArgs* args) {
      // 处理消息
      return S_OK;
    }
  ).Get(), &token);
```

#### 方案 B：共享内存（高性能数据传输）

用于大数据量传输（如桌宠模型数据、壁纸缓存）：

```cpp
// C++ 创建共享内存
HANDLE hMapFile = CreateFileMapping(
  INVALID_HANDLE_VALUE,
  NULL,
  PAGE_READWRITE,
  0,
  bufferSize,
  L"CodeCanvasSharedMemory"
);

// JavaScript 通过 WebAssembly 访问
```

### 2. 通信协议规范

**请求格式**：
```json
{
  "jsonrpc": "2.0",
  "method": "module.action",
  "params": {
    "key": "value"
  },
  "id": 123
}
```

**响应格式**：
```json
{
  "jsonrpc": "2.0",
  "result": {
    "success": true,
    "data": {}
  },
  "id": 123
}
```

**错误格式**：
```json
{
  "jsonrpc": "2.0",
  "error": {
    "code": -32600,
    "message": "Invalid Request",
    "data": {}
  },
  "id": 123
}
```

## 构建系统

### 1. C++ 构建：CMake 3.20+

**项目结构**：
```cmake
cmake_minimum_required(VERSION 3.20)
project(CodeCanvas VERSION 1.0.0 LANGUAGES CXX)

set(CMAKE_CXX_STANDARD 20)
set(CMAKE_CXX_STANDARD_REQUIRED ON)

# vcpkg 集成
set(CMAKE_TOOLCHAIN_FILE "${VCPKG_ROOT}/scripts/buildsystems/vcpkg.cmake")

# 查找依赖
find_package(nlohmann_json CONFIG REQUIRED)
find_package(spdlog CONFIG REQUIRED)
find_package(SQLite3 REQUIRED)

# 主程序
add_executable(CodeCanvas
  src/main.cpp
  src/core/Application.cpp
  src/ui/Window.cpp
  # ... 更多源文件
)

target_link_libraries(CodeCanvas PRIVATE
  nlohmann_json::nlohmann_json
  spdlog::spdlog
  d2d1.lib
  dwrite.lib
  WebView2LoaderStatic.lib
)

# 安装规则
install(TARGETS CodeCanvas DESTINATION bin)
install(DIRECTORY resources DESTINATION .)
```

### 2. 前端构建：npm scripts

```json
{
  "scripts": {
    "dev": "vite",
    "build": "vue-tsc --noEmit && vite build",
    "preview": "vite preview",
    "lint": "eslint . --ext .vue,.js,.jsx,.cjs,.mjs,.ts,.tsx,.cts,.mts --fix",
    "format": "prettier --write src/"
  }
}
```

### 3. 完整构建流程

```bash
# 1. 构建前端
cd frontend
npm install
npm run build
# 输出到 ../resources/web/

# 2. 构建 C++ 后端
cd ..
mkdir build && cd build
cmake -DCMAKE_BUILD_TYPE=Release ..
cmake --build . --config Release

# 3. 打包
cd ..
python scripts/package.py
# 输出: dist/CodeCanvas-1.0.0-Setup.exe
```

## 性能优化技术选型

### 1. 渲染优化

- **双缓冲渲染**：Direct2D 内置支持
- **脏矩形更新**：只重绘变化区域
- **GPU 合成**：利用 DWM 桌面合成

### 2. 内存优化

- **智能指针**：`std::unique_ptr`, `std::shared_ptr`
- **对象池**：频繁创建的小对象
- **延迟加载**：按需加载资源

### 3. 多线程

```cpp
// 线程模型
Main Thread        // UI 事件循环、WebView2
Render Thread      // Direct2D/D3D11 渲染
IO Thread          // 文件读写、网络
Worker Thread Pool // 计算密集型任务
```

## 数据存储

### 选择：SQLite 3

**Schema 设计**：
```sql
-- 配置表
CREATE TABLE config (
  key TEXT PRIMARY KEY,
  value TEXT NOT NULL,
  updated_at INTEGER
);

-- Dock 应用
CREATE TABLE dock_apps (
  id TEXT PRIMARY KEY,
  name TEXT NOT NULL,
  path TEXT NOT NULL,
  icon_path TEXT,
  position INTEGER,
  created_at INTEGER
);

-- 壁纸库
CREATE TABLE wallpapers (
  id TEXT PRIMARY KEY,
  name TEXT NOT NULL,
  type TEXT CHECK(type IN ('static', 'video')),
  file_path TEXT NOT NULL,
  thumbnail_path TEXT,
  tags TEXT,  -- JSON array
  created_at INTEGER
);

-- 桌宠配置
CREATE TABLE pets (
  id TEXT PRIMARY KEY,
  model_name TEXT NOT NULL,
  config TEXT,  -- JSON
  is_active INTEGER DEFAULT 0,
  created_at INTEGER
);
```

**备份策略**：
- 每日自动备份到 `%APPDATA%/CodeCanvas/backups/`
- 保留最近 7 天备份

## 日志系统

### spdlog 配置

```cpp
#include <spdlog/spdlog.h>
#include <spdlog/sinks/rotating_file_sink.h>
#include <spdlog/sinks/stdout_color_sinks.h>

void InitLogger() {
  auto console_sink = std::make_shared<spdlog::sinks::stdout_color_sink_mt>();
  console_sink->set_level(spdlog::level::debug);

  auto file_sink = std::make_shared<spdlog::sinks::rotating_file_sink_mt>(
    "logs/codecanvas.log", 1024 * 1024 * 10, 3  // 10MB, 3个文件轮转
  );
  file_sink->set_level(spdlog::level::trace);

  auto logger = std::make_shared<spdlog::logger>(
    "main", 
    spdlog::sinks_init_list{console_sink, file_sink}
  );
  spdlog::set_default_logger(logger);
  spdlog::set_level(spdlog::level::debug);
  spdlog::set_pattern("[%Y-%m-%d %H:%M:%S.%e] [%^%l%$] [%t] %v");
}
```

## 版本控制与发布

### 版本号规范：语义化版本

```
v{major}.{minor}.{patch}[-{pre-release}]

示例：
v1.0.0        // 首个稳定版
v1.1.0        // 新增功能
v1.1.1        // Bug 修复
v2.0.0-beta.1 // 大版本预览
```

### 自动更新

- **框架**：自研轻量更新器
- **协议**：HTTPS
- **策略**：差分更新（BSDiff）

```cpp
// 更新检查
struct UpdateInfo {
  std::string version;
  std::string download_url;
  std::string changelog;
  std::string signature;  // RSA签名
  size_t size;
};
```

## 安全性考虑

1. **WebView2 安全配置**：
```cpp
settings->put_IsScriptEnabled(TRUE);
settings->put_AreDefaultScriptDialogsEnabled(FALSE);  // 禁用 alert
settings->put_IsWebMessageEnabled(TRUE);
settings->put_AreDevToolsEnabled(FALSE);  // Release 禁用
```

2. **内容安全策略 (CSP)**：
```html
<meta http-equiv="Content-Security-Policy" 
      content="default-src 'self'; script-src 'self'; style-src 'self' 'unsafe-inline';">
```

3. **代码签名**：使用 EV 证书签名可执行文件

---

*技术选型将根据开发过程中的实际情况进行评估和调整*

