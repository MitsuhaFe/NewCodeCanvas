# 开发环境配置文档

## 系统要求

### 开发环境

- **操作系统**：Windows 10/11 (64-bit)
- **CPU**：Intel Core i5 或 AMD Ryzen 5 及以上
- **内存**：16GB RAM（推荐）
- **磁盘**：20GB 可用空间（用于开发工具和依赖）
- **显卡**：支持 DirectX 11 的独立显卡（推荐）

### 必需软件

| 软件 | 版本 | 用途 |
|------|------|------|
| Visual Studio 2022 | Community 或以上 | C++ 开发 |
| CMake | 3.20+ | 构建系统 |
| Node.js | 18.x LTS | 前端开发 |
| Git | 2.40+ | 版本控制 |
| vcpkg | 最新 | C++ 包管理 |

## 工具安装

### 1. Visual Studio 2022

#### 下载与安装

1. 访问：https://visualstudio.microsoft.com/downloads/
2. 选择 **Community 版本**（免费）
3. 运行安装程序

#### 工作负载选择

必须选择以下工作负载：

- [x] **使用 C++ 的桌面开发**
  - MSVC v143
  - Windows 11 SDK (10.0.22621.0 或更高)
  - CMake 工具
  - C++ ATL
  - C++ AddressSanitizer

可选：
- [ ] .NET 桌面开发（用于工具开发）

#### 单个组件

确保已安装：
- C++ 2022 Redistributable Update
- Windows Universal CRT SDK
- C++ CMake tools for Windows

### 2. CMake

#### 安装

**方式一：通过 Visual Studio Installer**（推荐）
- 已在上一步中安装

**方式二：独立安装**
```powershell
# 使用 winget
winget install Kitware.CMake

# 或使用 Chocolatey
choco install cmake --installargs 'ADD_CMAKE_TO_PATH=System'
```

#### 验证

```powershell
cmake --version
# 输出: cmake version 3.27.x
```

### 3. vcpkg

#### 安装

```powershell
# 克隆 vcpkg
cd C:\
git clone https://github.com/microsoft/vcpkg.git
cd vcpkg

# 运行 bootstrap
.\bootstrap-vcpkg.bat

# 集成到 Visual Studio
.\vcpkg integrate install
```

#### 配置环境变量

```powershell
# 添加到系统环境变量
$env:VCPKG_ROOT = "C:\vcpkg"
[System.Environment]::SetEnvironmentVariable('VCPKG_ROOT', 'C:\vcpkg', 'User')
```

#### 安装依赖

```powershell
cd C:\vcpkg

# 安装项目依赖
.\vcpkg install nlohmann-json:x64-windows
.\vcpkg install spdlog:x64-windows
.\vcpkg install sqlite3:x64-windows
.\vcpkg install curl:x64-windows
.\vcpkg install boost-asio:x64-windows
.\vcpkg install websocketpp:x64-windows

# 查看已安装包
.\vcpkg list
```

### 4. Node.js

#### 安装

```powershell
# 使用 winget
winget install OpenJS.NodeJS.LTS

# 或使用 nvm-windows（推荐）
# 1. 下载 nvm-setup.exe from https://github.com/coreybutler/nvm-windows/releases
# 2. 安装后：
nvm install 18
nvm use 18
```

#### 验证

```powershell
node --version
# 输出: v18.x.x

npm --version
# 输出: 9.x.x
```

#### 配置 npm

```powershell
# 设置国内镜像（可选，加速下载）
npm config set registry https://registry.npmmirror.com

# 安装全局工具
npm install -g pnpm
npm install -g typescript
```

### 5. Git

#### 安装

```powershell
# 使用 winget
winget install Git.Git
```

#### 配置

```powershell
# 设置用户信息
git config --global user.name "Your Name"
git config --global user.email "your.email@example.com"

# 设置默认编辑器
git config --global core.editor "code --wait"

# 设置换行符（Windows）
git config --global core.autocrlf true

# 启用长路径支持
git config --global core.longpaths true
```

### 6. 推荐工具

#### Visual Studio Code

```powershell
winget install Microsoft.VisualStudioCode
```

**推荐扩展**：
- C/C++ (Microsoft)
- CMake Tools (Microsoft)
- Vue Language Features (Volar)
- ESLint
- Prettier
- GitLens

#### 其他工具

```powershell
# Windows Terminal
winget install Microsoft.WindowsTerminal

# PowerToys（可选，提升生产力）
winget install Microsoft.PowerToys
```

## 项目设置

### 克隆项目

```powershell
# 创建工作目录
cd D:\CodeProject\PBL2
git clone https://github.com/your-org/codecanvas.git CodeCanvas
cd CodeCanvas
```

### 项目结构

```
CodeCanvas/
├── backend/              # C++ 后端
│   ├── src/
│   │   ├── main.cpp
│   │   ├── core/
│   │   ├── modules/
│   │   ├── render/
│   │   └── ...
│   ├── include/
│   ├── CMakeLists.txt
│   └── vcpkg.json
├── frontend/             # Vue 前端
│   ├── src/
│   │   ├── main.ts
│   │   ├── App.vue
│   │   ├── components/
│   │   ├── views/
│   │   ├── api/
│   │   └── stores/
│   ├── public/
│   ├── index.html
│   ├── package.json
│   ├── vite.config.ts
│   └── tsconfig.json
├── resources/            # 资源文件
│   ├── icons/
│   ├── images/
│   └── web/             # 前端构建输出
├── docs/                # 文档
├── scripts/             # 构建脚本
├── tests/               # 测试
├── build/               # CMake 构建目录（gitignore）
└── README.md
```

### 后端配置

#### CMakeLists.txt

```cmake
cmake_minimum_required(VERSION 3.20)
project(CodeCanvas VERSION 1.0.0 LANGUAGES CXX)

# C++20 标准
set(CMAKE_CXX_STANDARD 20)
set(CMAKE_CXX_STANDARD_REQUIRED ON)

# vcpkg 集成
if(DEFINED ENV{VCPKG_ROOT})
  set(CMAKE_TOOLCHAIN_FILE "$ENV{VCPKG_ROOT}/scripts/buildsystems/vcpkg.cmake"
      CACHE STRING "Vcpkg toolchain file")
endif()

# 查找依赖
find_package(nlohmann_json CONFIG REQUIRED)
find_package(spdlog CONFIG REQUIRED)
find_package(SQLite3 REQUIRED)
find_package(CURL CONFIG REQUIRED)
find_package(Boost REQUIRED COMPONENTS system)
find_package(websocketpp CONFIG REQUIRED)

# 源文件
file(GLOB_RECURSE SOURCES "src/*.cpp")
file(GLOB_RECURSE HEADERS "include/*.h")

# 可执行文件
add_executable(${PROJECT_NAME} ${SOURCES} ${HEADERS})

# 包含目录
target_include_directories(${PROJECT_NAME} PRIVATE
  ${CMAKE_CURRENT_SOURCE_DIR}/include
  ${CMAKE_CURRENT_SOURCE_DIR}/src
)

# 链接库
target_link_libraries(${PROJECT_NAME} PRIVATE
  nlohmann_json::nlohmann_json
  spdlog::spdlog
  SQLite::SQLite3
  CURL::libcurl
  Boost::system
  websocketpp::websocketpp
  # Windows 库
  d2d1.lib
  dwrite.lib
  d3d11.lib
  dxgi.lib
  windowscodecs.lib
  shlwapi.lib
  # WebView2
  ${CMAKE_CURRENT_SOURCE_DIR}/libs/WebView2/Microsoft.Web.WebView2.1.0.2210.55/build/native/x64/WebView2LoaderStatic.lib
)

# 预编译头（可选）
target_precompile_headers(${PROJECT_NAME} PRIVATE
  <string>
  <vector>
  <memory>
  <map>
  <algorithm>
  <nlohmann/json.hpp>
  <spdlog/spdlog.h>
)

# 编译选项
if(MSVC)
  target_compile_options(${PROJECT_NAME} PRIVATE
    /W4           # 警告级别 4
    /WX           # 警告视为错误
    /permissive-  # 严格标准符合
    /utf-8        # UTF-8 编码
  )
  
  # Release 优化
  target_compile_options(${PROJECT_NAME} PRIVATE
    $<$<CONFIG:Release>:/O2 /Ob2 /Oi /Ot /GL>
  )
  target_link_options(${PROJECT_NAME} PRIVATE
    $<$<CONFIG:Release>:/LTCG /OPT:REF /OPT:ICF>
  )
endif()

# 安装规则
install(TARGETS ${PROJECT_NAME} DESTINATION bin)
install(DIRECTORY ${CMAKE_CURRENT_SOURCE_DIR}/resources DESTINATION .)
```

#### vcpkg.json

```json
{
  "name": "codecanvas",
  "version": "1.0.0",
  "dependencies": [
    "nlohmann-json",
    "spdlog",
    "sqlite3",
    "curl",
    "boost-asio",
    "websocketpp"
  ]
}
```

### 前端配置

#### package.json

```json
{
  "name": "codecanvas-frontend",
  "version": "1.0.0",
  "type": "module",
  "scripts": {
    "dev": "vite",
    "build": "vue-tsc --noEmit && vite build",
    "preview": "vite preview",
    "lint": "eslint . --ext .vue,.js,.jsx,.cjs,.mjs,.ts,.tsx --fix",
    "format": "prettier --write src/"
  },
  "dependencies": {
    "vue": "^3.3.4",
    "pinia": "^2.1.7",
    "vue-router": "^4.2.5",
    "gsap": "^3.12.2"
  },
  "devDependencies": {
    "@vitejs/plugin-vue": "^4.4.0",
    "@vue/tsconfig": "^0.4.0",
    "typescript": "^5.2.2",
    "vite": "^5.0.0",
    "vue-tsc": "^1.8.22",
    "@typescript-eslint/eslint-plugin": "^6.10.0",
    "@typescript-eslint/parser": "^6.10.0",
    "eslint": "^8.53.0",
    "eslint-plugin-vue": "^9.18.1",
    "prettier": "^3.1.0"
  }
}
```

#### vite.config.ts

```typescript
import { defineConfig } from 'vite'
import vue from '@vitejs/plugin-vue'
import { resolve } from 'path'

export default defineConfig({
  plugins: [vue()],
  
  resolve: {
    alias: {
      '@': resolve(__dirname, 'src')
    }
  },
  
  base: './',  // 相对路径（用于 WebView2）
  
  build: {
    outDir: '../resources/web',
    emptyOutDir: true,
    target: 'es2020',
    minify: 'terser',
    sourcemap: false,
    rollupOptions: {
      output: {
        manualChunks: {
          'vue-vendor': ['vue', 'pinia', 'vue-router'],
          'animation': ['gsap']
        }
      }
    }
  },
  
  server: {
    port: 5173,
    strictPort: true,
    host: '127.0.0.1'
  }
})
```

#### tsconfig.json

```json
{
  "compilerOptions": {
    "target": "ES2020",
    "module": "ESNext",
    "moduleResolution": "bundler",
    "strict": true,
    "jsx": "preserve",
    "sourceMap": true,
    "resolveJsonModule": true,
    "esModuleInterop": true,
    "lib": ["ES2020", "DOM", "DOM.Iterable"],
    "skipLibCheck": true,
    "types": ["vite/client"],
    "baseUrl": ".",
    "paths": {
      "@/*": ["./src/*"]
    }
  },
  "include": ["src/**/*.ts", "src/**/*.vue"],
  "exclude": ["node_modules"]
}
```

#### .eslintrc.cjs

```javascript
module.exports = {
  root: true,
  env: {
    browser: true,
    es2021: true,
    node: true
  },
  extends: [
    'eslint:recommended',
    'plugin:vue/vue3-recommended',
    'plugin:@typescript-eslint/recommended'
  ],
  parser: 'vue-eslint-parser',
  parserOptions: {
    parser: '@typescript-eslint/parser',
    ecmaVersion: 2021,
    sourceType: 'module'
  },
  rules: {
    'vue/multi-word-component-names': 'off',
    '@typescript-eslint/no-explicit-any': 'warn'
  }
}
```

## 构建项目

### 初次构建

```powershell
# 1. 进入项目目录
cd D:\CodeProject\PBL2\CodeCanvas

# 2. 构建前端
cd frontend
npm install
npm run build

# 3. 构建后端
cd ..
mkdir build
cd build
cmake .. -G "Visual Studio 17 2022" -A x64
cmake --build . --config Debug

# 4. 运行
.\Debug\CodeCanvas.exe
```

### 开发模式

#### 后端开发

```powershell
# Visual Studio
# 1. 打开 backend 文件夹
# 2. 选择 CMakeLists.txt
# 3. F5 运行调试

# 或使用 CMake
cd build
cmake --build . --config Debug
.\Debug\CodeCanvas.exe
```

#### 前端开发

```powershell
cd frontend
npm run dev
# 访问 http://localhost:5173
```

**开发流程**：
1. 后端运行 Release 构建（或不运行）
2. 前端使用 Vite 开发服务器
3. 修改代码自动热重载

### 调试配置

#### Visual Studio（C++）

**launch.vs.json**：
```json
{
  "version": "0.2.1",
  "defaults": {},
  "configurations": [
    {
      "type": "default",
      "project": "CMakeLists.txt",
      "projectTarget": "CodeCanvas.exe",
      "name": "CodeCanvas (Debug)",
      "currentDir": "${workspaceRoot}",
      "args": ["--dev"]
    }
  ]
}
```

#### VS Code（前端）

**.vscode/launch.json**：
```json
{
  "version": "0.2.0",
  "configurations": [
    {
      "type": "chrome",
      "request": "launch",
      "name": "Launch Chrome",
      "url": "http://localhost:5173",
      "webRoot": "${workspaceFolder}/frontend/src"
    }
  ]
}
```

## 常见问题

### 1. vcpkg 依赖安装失败

**问题**：网络问题导致下载失败

**解决**：
```powershell
# 使用代理
$env:HTTP_PROXY="http://proxy.example.com:8080"
$env:HTTPS_PROXY="http://proxy.example.com:8080"

# 或使用镜像（中国大陆）
.\vcpkg install --x-buildtrees-root=D:\vcpkg_cache
```

### 2. CMake 找不到 vcpkg

**问题**：`Could not find vcpkg toolchain file`

**解决**：
```powershell
# 方式一：设置环境变量
$env:VCPKG_ROOT="C:\vcpkg"

# 方式二：手动指定
cmake .. -DCMAKE_TOOLCHAIN_FILE=C:/vcpkg/scripts/buildsystems/vcpkg.cmake
```

### 3. WebView2 SDK 缺失

**问题**：`Cannot find WebView2Loader.dll`

**解决**：
```powershell
# 下载 WebView2 SDK
# https://www.nuget.org/packages/Microsoft.Web.WebView2

# 解压到项目 libs 目录
mkdir backend\libs\WebView2
# 解压 NuGet 包到此目录
```

### 4. 前端依赖安装慢

**解决**：
```powershell
# 使用 pnpm（更快）
npm install -g pnpm
cd frontend
pnpm install

# 或使用 npm 镜像
npm config set registry https://registry.npmmirror.com
```

### 5. Unicode 编译错误

**问题**：中文字符编译错误

**解决**：
```cmake
# CMakeLists.txt 添加
target_compile_options(${PROJECT_NAME} PRIVATE /utf-8)
```

```cpp
// 源文件开头添加
#pragma execution_character_set("utf-8")
```

## 代码规范工具

### ClangFormat（C++）

**.clang-format**：
```yaml
BasedOnStyle: Google
IndentWidth: 2
ColumnLimit: 100
PointerAlignment: Left
```

### Prettier（前端）

**.prettierrc.json**：
```json
{
  "semi": false,
  "singleQuote": true,
  "tabWidth": 2,
  "trailingComma": "none",
  "printWidth": 100
}
```

## 下一步

完成环境配置后，请参阅：
- [08-构建与部署.md](./08-构建与部署.md) - 了解完整构建流程
- [03-模块设计.md](./03-模块设计.md) - 开始模块开发

---

*环境配置如有问题，请提交 Issue 或联系技术负责人*

