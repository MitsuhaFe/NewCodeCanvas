# 数据库设计文档

## 数据库选型

**选择**：SQLite 3.43.0

**理由**：
- 轻量级：无需独立服务器进程
- 零配置：单文件数据库
- 高性能：适合本地应用
- 跨平台：支持 Windows/macOS/Linux
- 可靠性：ACID 事务支持
- 体积小：<1MB 库文件

**位置**：`%APPDATA%/CodeCanvas/data/codecanvas.db`

## 数据库架构

### 表结构概览

```sql
-- 配置表
config

-- Dock 相关
dock_apps
dock_settings

-- 壁纸相关
wallpapers
wallpaper_tags
wallpaper_playlists
wallpaper_playlist_items

-- 桌宠相关
pet_models
pet_instances
pet_instance_config

-- 用户数据
user_preferences
usage_statistics
```

## 详细表设计

### 1. config - 配置表

存储应用级别的配置项。

```sql
CREATE TABLE config (
  key TEXT PRIMARY KEY NOT NULL,
  value TEXT NOT NULL,
  type TEXT NOT NULL CHECK(type IN ('string', 'number', 'boolean', 'json')),
  description TEXT,
  updated_at INTEGER NOT NULL DEFAULT (strftime('%s', 'now')),
  created_at INTEGER NOT NULL DEFAULT (strftime('%s', 'now'))
);

-- 索引
CREATE INDEX idx_config_updated ON config(updated_at DESC);

-- 示例数据
INSERT INTO config VALUES
  ('app.version', '1.0.0', 'string', '应用版本', strftime('%s', 'now'), strftime('%s', 'now')),
  ('app.language', 'zh-CN', 'string', '界面语言', strftime('%s', 'now'), strftime('%s', 'now')),
  ('app.theme', 'dark', 'string', '主题', strftime('%s', 'now'), strftime('%s', 'now')),
  ('app.start_with_system', '1', 'boolean', '开机启动', strftime('%s', 'now'), strftime('%s', 'now')),
  ('app.check_updates', '1', 'boolean', '自动检查更新', strftime('%s', 'now'), strftime('%s', 'now'));
```

### 2. dock_apps - Dock 应用

存储 Dock 栏中的应用程序。

```sql
CREATE TABLE dock_apps (
  id TEXT PRIMARY KEY NOT NULL,  -- UUID
  name TEXT NOT NULL,
  path TEXT NOT NULL UNIQUE,     -- 可执行文件路径
  icon_path TEXT,                -- 自定义图标路径（可选）
  position INTEGER NOT NULL,     -- 排序位置（0-based）
  is_pinned INTEGER NOT NULL DEFAULT 1 CHECK(is_pinned IN (0, 1)),
  show_badge INTEGER NOT NULL DEFAULT 1 CHECK(show_badge IN (0, 1)),
  arguments TEXT,                -- 启动参数
  working_directory TEXT,        -- 工作目录
  launch_count INTEGER NOT NULL DEFAULT 0,  -- 启动次数
  last_launched INTEGER,         -- 最后启动时间
  created_at INTEGER NOT NULL DEFAULT (strftime('%s', 'now')),
  updated_at INTEGER NOT NULL DEFAULT (strftime('%s', 'now'))
);

-- 索引
CREATE INDEX idx_dock_apps_position ON dock_apps(position ASC);
CREATE INDEX idx_dock_apps_pinned ON dock_apps(is_pinned DESC);
CREATE INDEX idx_dock_apps_launch_count ON dock_apps(launch_count DESC);

-- 触发器：更新 updated_at
CREATE TRIGGER trigger_dock_apps_update 
AFTER UPDATE ON dock_apps
BEGIN
  UPDATE dock_apps SET updated_at = strftime('%s', 'now') WHERE id = NEW.id;
END;
```

### 3. dock_settings - Dock 设置

存储 Dock 的全局设置。

```sql
CREATE TABLE dock_settings (
  id INTEGER PRIMARY KEY CHECK(id = 1),  -- 单例表
  position TEXT NOT NULL DEFAULT 'bottom' CHECK(position IN ('top', 'bottom', 'left', 'right')),
  auto_hide INTEGER NOT NULL DEFAULT 0 CHECK(auto_hide IN (0, 1)),
  icon_size INTEGER NOT NULL DEFAULT 48 CHECK(icon_size BETWEEN 24 AND 128),
  max_icon_size INTEGER NOT NULL DEFAULT 64 CHECK(max_icon_size BETWEEN 32 AND 256),
  spacing REAL NOT NULL DEFAULT 8.0 CHECK(spacing >= 0),
  margin REAL NOT NULL DEFAULT 10.0 CHECK(margin >= 0),
  corner_radius REAL NOT NULL DEFAULT 12.0 CHECK(corner_radius >= 0),
  background_color TEXT NOT NULL DEFAULT '#1E1E1ECC',  -- RGBA hex
  theme_id TEXT NOT NULL DEFAULT 'default',
  show_running_indicator INTEGER NOT NULL DEFAULT 1 CHECK(show_running_indicator IN (0, 1)),
  magnification_enabled INTEGER NOT NULL DEFAULT 1 CHECK(magnification_enabled IN (0, 1)),
  updated_at INTEGER NOT NULL DEFAULT (strftime('%s', 'now')),
  created_at INTEGER NOT NULL DEFAULT (strftime('%s', 'now'))
);

-- 插入默认设置
INSERT INTO dock_settings (id) VALUES (1);

-- 触发器
CREATE TRIGGER trigger_dock_settings_update 
AFTER UPDATE ON dock_settings
BEGIN
  UPDATE dock_settings SET updated_at = strftime('%s', 'now') WHERE id = 1;
END;
```

### 4. wallpapers - 壁纸

存储壁纸库中的所有壁纸。

```sql
CREATE TABLE wallpapers (
  id TEXT PRIMARY KEY NOT NULL,  -- UUID
  name TEXT NOT NULL,
  type TEXT NOT NULL CHECK(type IN ('static', 'video', 'web')),
  file_path TEXT NOT NULL UNIQUE,  -- 原始文件路径
  thumbnail_path TEXT,             -- 缩略图路径
  file_size INTEGER NOT NULL,      -- 文件大小（字节）
  
  -- 媒体信息
  width INTEGER,
  height INTEGER,
  duration REAL,                   -- 视频时长（秒）
  fps REAL,                        -- 帧率
  
  -- 元数据
  description TEXT,
  source TEXT,                     -- 来源URL
  author TEXT,
  
  -- 统计
  use_count INTEGER NOT NULL DEFAULT 0,
  last_used INTEGER,
  is_favorite INTEGER NOT NULL DEFAULT 0 CHECK(is_favorite IN (0, 1)),
  
  -- 时间戳
  created_at INTEGER NOT NULL DEFAULT (strftime('%s', 'now')),
  updated_at INTEGER NOT NULL DEFAULT (strftime('%s', 'now'))
);

-- 索引
CREATE INDEX idx_wallpapers_type ON wallpapers(type);
CREATE INDEX idx_wallpapers_favorite ON wallpapers(is_favorite DESC, created_at DESC);
CREATE INDEX idx_wallpapers_use_count ON wallpapers(use_count DESC);
CREATE INDEX idx_wallpapers_created ON wallpapers(created_at DESC);

-- 触发器
CREATE TRIGGER trigger_wallpapers_update 
AFTER UPDATE ON wallpapers
BEGIN
  UPDATE wallpapers SET updated_at = strftime('%s', 'now') WHERE id = NEW.id;
END;

-- FTS 全文搜索（可选）
CREATE VIRTUAL TABLE wallpapers_fts USING fts5(
  id UNINDEXED, 
  name, 
  description, 
  author
);
```

### 5. wallpaper_tags - 壁纸标签

多对多关系：壁纸和标签。

```sql
CREATE TABLE wallpaper_tags (
  wallpaper_id TEXT NOT NULL,
  tag TEXT NOT NULL,
  created_at INTEGER NOT NULL DEFAULT (strftime('%s', 'now')),
  PRIMARY KEY (wallpaper_id, tag),
  FOREIGN KEY (wallpaper_id) REFERENCES wallpapers(id) ON DELETE CASCADE
);

-- 索引
CREATE INDEX idx_wallpaper_tags_tag ON wallpaper_tags(tag);
CREATE INDEX idx_wallpaper_tags_wallpaper ON wallpaper_tags(wallpaper_id);

-- 常用标签视图
CREATE VIEW popular_tags AS
SELECT tag, COUNT(*) as count
FROM wallpaper_tags
GROUP BY tag
ORDER BY count DESC;
```

### 6. wallpaper_playlists - 壁纸播放列表

```sql
CREATE TABLE wallpaper_playlists (
  id TEXT PRIMARY KEY NOT NULL,  -- UUID
  name TEXT NOT NULL,
  description TEXT,
  shuffle INTEGER NOT NULL DEFAULT 0 CHECK(shuffle IN (0, 1)),
  interval INTEGER NOT NULL DEFAULT 3600,  -- 切换间隔（秒）
  is_active INTEGER NOT NULL DEFAULT 0 CHECK(is_active IN (0, 1)),
  created_at INTEGER NOT NULL DEFAULT (strftime('%s', 'now')),
  updated_at INTEGER NOT NULL DEFAULT (strftime('%s', 'now'))
);

CREATE TABLE wallpaper_playlist_items (
  playlist_id TEXT NOT NULL,
  wallpaper_id TEXT NOT NULL,
  position INTEGER NOT NULL,
  PRIMARY KEY (playlist_id, wallpaper_id),
  FOREIGN KEY (playlist_id) REFERENCES wallpaper_playlists(id) ON DELETE CASCADE,
  FOREIGN KEY (wallpaper_id) REFERENCES wallpapers(id) ON DELETE CASCADE
);

-- 索引
CREATE INDEX idx_playlist_items_position ON wallpaper_playlist_items(playlist_id, position);
```

### 7. pet_models - 桌宠模型

存储可用的桌宠模型定义。

```sql
CREATE TABLE pet_models (
  name TEXT PRIMARY KEY NOT NULL,  -- 模型名称（唯一标识）
  display_name TEXT NOT NULL,      -- 显示名称
  description TEXT,
  thumbnail_path TEXT,
  directory_path TEXT NOT NULL,    -- 模型资源目录
  
  -- 动画定义（JSON）
  animations TEXT NOT NULL,        -- JSON: {"idle": {...}, "walk": {...}}
  default_animation TEXT NOT NULL DEFAULT 'idle',
  
  -- 物理属性
  mass REAL NOT NULL DEFAULT 1.0,
  friction REAL NOT NULL DEFAULT 0.8,
  
  -- 元数据
  version TEXT,
  author TEXT,
  
  -- 统计
  spawn_count INTEGER NOT NULL DEFAULT 0,
  
  -- 时间戳
  created_at INTEGER NOT NULL DEFAULT (strftime('%s', 'now')),
  updated_at INTEGER NOT NULL DEFAULT (strftime('%s', 'now'))
);

-- 索引
CREATE INDEX idx_pet_models_spawn_count ON pet_models(spawn_count DESC);

-- 触发器
CREATE TRIGGER trigger_pet_models_update 
AFTER UPDATE ON pet_models
BEGIN
  UPDATE pet_models SET updated_at = strftime('%s', 'now') WHERE name = NEW.name;
END;
```

### 8. pet_instances - 桌宠实例

存储当前激活的桌宠实例。

```sql
CREATE TABLE pet_instances (
  id TEXT PRIMARY KEY NOT NULL,  -- UUID
  model_name TEXT NOT NULL,
  
  -- 位置和状态
  x REAL NOT NULL DEFAULT 0.0,
  y REAL NOT NULL DEFAULT 0.0,
  scale REAL NOT NULL DEFAULT 1.0 CHECK(scale > 0),
  flip_x INTEGER NOT NULL DEFAULT 0 CHECK(flip_x IN (0, 1)),
  
  -- 当前动画
  current_animation TEXT,
  current_frame INTEGER NOT NULL DEFAULT 0,
  
  -- 自定义配置（JSON）
  config TEXT DEFAULT '{}',
  
  -- 时间戳
  created_at INTEGER NOT NULL DEFAULT (strftime('%s', 'now')),
  updated_at INTEGER NOT NULL DEFAULT (strftime('%s', 'now')),
  
  FOREIGN KEY (model_name) REFERENCES pet_models(name) ON DELETE CASCADE
);

-- 索引
CREATE INDEX idx_pet_instances_model ON pet_instances(model_name);

-- 触发器
CREATE TRIGGER trigger_pet_instances_update 
AFTER UPDATE ON pet_instances
BEGIN
  UPDATE pet_instances SET updated_at = strftime('%s', 'now') WHERE id = NEW.id;
END;
```

### 9. user_preferences - 用户偏好

存储用户的各种偏好设置。

```sql
CREATE TABLE user_preferences (
  category TEXT NOT NULL,
  key TEXT NOT NULL,
  value TEXT NOT NULL,
  type TEXT NOT NULL CHECK(type IN ('string', 'number', 'boolean', 'json')),
  updated_at INTEGER NOT NULL DEFAULT (strftime('%s', 'now')),
  PRIMARY KEY (category, key)
);

-- 索引
CREATE INDEX idx_user_preferences_category ON user_preferences(category);

-- 示例数据
INSERT INTO user_preferences VALUES
  ('wallpaper', 'fit_mode', 'fill', 'string', strftime('%s', 'now')),
  ('wallpaper', 'auto_change', '1', 'boolean', strftime('%s', 'now')),
  ('wallpaper', 'change_interval', '3600', 'number', strftime('%s', 'now')),
  ('pet', 'enabled', '1', 'boolean', strftime('%s', 'now')),
  ('pet', 'interaction_enabled', '1', 'boolean', strftime('%s', 'now'));
```

### 10. usage_statistics - 使用统计

存储应用使用统计数据（用于优化和分析）。

```sql
CREATE TABLE usage_statistics (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  event_type TEXT NOT NULL,
  event_data TEXT,  -- JSON
  timestamp INTEGER NOT NULL DEFAULT (strftime('%s', 'now'))
);

-- 索引
CREATE INDEX idx_usage_stats_type ON usage_statistics(event_type, timestamp DESC);
CREATE INDEX idx_usage_stats_timestamp ON usage_statistics(timestamp DESC);

-- 清理旧数据（保留最近 30 天）
CREATE TRIGGER trigger_cleanup_old_stats
AFTER INSERT ON usage_statistics
BEGIN
  DELETE FROM usage_statistics 
  WHERE timestamp < strftime('%s', 'now', '-30 days');
END;
```

## 视图定义

### 常用查询视图

```sql
-- 活跃壁纸视图（按使用频率）
CREATE VIEW active_wallpapers AS
SELECT 
  w.*,
  GROUP_CONCAT(wt.tag, ',') as tags
FROM wallpapers w
LEFT JOIN wallpaper_tags wt ON w.id = wt.wallpaper_id
WHERE w.use_count > 0
GROUP BY w.id
ORDER BY w.use_count DESC, w.last_used DESC;

-- Dock 应用统计
CREATE VIEW dock_app_stats AS
SELECT 
  name,
  path,
  launch_count,
  CASE 
    WHEN last_launched IS NULL THEN '从未启动'
    WHEN last_launched > strftime('%s', 'now', '-1 day') THEN '今天'
    WHEN last_launched > strftime('%s', 'now', '-7 days') THEN '本周'
    ELSE '更早'
  END as last_launch_period
FROM dock_apps
ORDER BY launch_count DESC;

-- 桌宠使用情况
CREATE VIEW pet_usage AS
SELECT 
  pm.display_name,
  pm.spawn_count,
  COUNT(pi.id) as active_instances
FROM pet_models pm
LEFT JOIN pet_instances pi ON pm.name = pi.model_name
GROUP BY pm.name
ORDER BY pm.spawn_count DESC;
```

## 数据库初始化

### C++ 初始化代码

```cpp
// src/core/Database.h
class Database {
public:
  static Database& Instance();
  
  bool Initialize(const std::string& dbPath);
  void Close();
  
  // 执行 SQL
  bool Execute(const std::string& sql);
  nlohmann::json Query(const std::string& sql);
  
  // 事务
  class Transaction {
  public:
    Transaction(Database& db);
    ~Transaction();
    void Commit();
    void Rollback();
  private:
    Database& m_db;
    bool m_committed = false;
  };
  
  Transaction BeginTransaction();
  
  // 预处理语句
  class Statement {
  public:
    Statement(sqlite3_stmt* stmt);
    ~Statement();
    
    void Bind(int index, const std::string& value);
    void Bind(int index, int value);
    void Bind(int index, double value);
    
    bool Step();
    void Reset();
    
    std::string GetString(int column);
    int GetInt(int column);
    double GetDouble(int column);
    
  private:
    sqlite3_stmt* m_stmt;
  };
  
  Statement Prepare(const std::string& sql);
  
private:
  Database() = default;
  
  bool CreateTables();
  bool RunMigrations();
  
  sqlite3* m_db = nullptr;
  std::mutex m_mutex;
};

// 使用示例
bool Database::Initialize(const std::string& dbPath) {
  std::lock_guard<std::mutex> lock(m_mutex);
  
  int rc = sqlite3_open(dbPath.c_str(), &m_db);
  if (rc != SQLITE_OK) {
    spdlog::error("Failed to open database: {}", sqlite3_errmsg(m_db));
    return false;
  }
  
  // 启用外键约束
  Execute("PRAGMA foreign_keys = ON;");
  
  // 性能优化
  Execute("PRAGMA journal_mode = WAL;");     // Write-Ahead Logging
  Execute("PRAGMA synchronous = NORMAL;");
  Execute("PRAGMA cache_size = -64000;");    // 64MB 缓存
  Execute("PRAGMA temp_store = MEMORY;");
  
  // 创建表
  if (!CreateTables()) {
    return false;
  }
  
  // 运行迁移
  if (!RunMigrations()) {
    return false;
  }
  
  return true;
}
```

### 建表脚本

```cpp
bool Database::CreateTables() {
  const char* schema = R"(
    -- [所有表的 CREATE TABLE 语句...]
    -- [所有索引的 CREATE INDEX 语句...]
    -- [所有触发器的 CREATE TRIGGER 语句...]
    -- [所有视图的 CREATE VIEW 语句...]
  )";
  
  return Execute(schema);
}
```

## 数据迁移

### 版本管理

```sql
CREATE TABLE schema_version (
  version INTEGER PRIMARY KEY,
  description TEXT,
  applied_at INTEGER NOT NULL DEFAULT (strftime('%s', 'now'))
);

INSERT INTO schema_version (version, description) VALUES (1, '初始化数据库');
```

### 迁移脚本示例

```cpp
// src/core/Migrations.cpp
bool Database::RunMigrations() {
  // 获取当前版本
  int currentVersion = 0;
  auto result = Query("SELECT MAX(version) as version FROM schema_version");
  if (!result.empty()) {
    currentVersion = result[0]["version"];
  }
  
  // 迁移列表
  std::vector<std::pair<int, std::function<bool()>>> migrations = {
    {2, [this]() {
      // v2: 添加壁纸播放列表功能
      return Execute(R"(
        CREATE TABLE wallpaper_playlists (...);
        CREATE TABLE wallpaper_playlist_items (...);
        INSERT INTO schema_version (version, description) 
        VALUES (2, '添加壁纸播放列表');
      )");
    }},
    
    {3, [this]() {
      // v3: 添加桌宠 AI 对话配置
      return Execute(R"(
        ALTER TABLE pet_instances ADD COLUMN ai_enabled INTEGER DEFAULT 0;
        INSERT INTO schema_version (version, description) 
        VALUES (3, '添加桌宠 AI 对话');
      )");
    }}
  };
  
  // 执行迁移
  for (const auto& [version, migration] : migrations) {
    if (version > currentVersion) {
      spdlog::info("Applying migration v{}", version);
      
      auto tx = BeginTransaction();
      if (!migration()) {
        spdlog::error("Migration v{} failed", version);
        tx.Rollback();
        return false;
      }
      tx.Commit();
    }
  }
  
  return true;
}
```

## 数据访问层 (DAO)

### DockAppDAO 示例

```cpp
// src/dao/DockAppDAO.h
class DockAppDAO {
public:
  static std::vector<DockApp> GetAll();
  static std::optional<DockApp> GetById(const std::string& id);
  static std::optional<DockApp> GetByPath(const std::string& path);
  
  static bool Insert(const DockApp& app);
  static bool Update(const DockApp& app);
  static bool Delete(const std::string& id);
  
  static bool UpdatePosition(const std::string& id, int position);
  static bool IncrementLaunchCount(const std::string& id);
  
private:
  static DockApp FromRow(const nlohmann::json& row);
};

// 实现
std::vector<DockApp> DockAppDAO::GetAll() {
  auto& db = Database::Instance();
  auto results = db.Query(
    "SELECT * FROM dock_apps ORDER BY position ASC"
  );
  
  std::vector<DockApp> apps;
  for (const auto& row : results) {
    apps.push_back(FromRow(row));
  }
  return apps;
}

bool DockAppDAO::Insert(const DockApp& app) {
  auto& db = Database::Instance();
  auto stmt = db.Prepare(R"(
    INSERT INTO dock_apps (id, name, path, icon_path, position, is_pinned)
    VALUES (?, ?, ?, ?, ?, ?)
  )");
  
  stmt.Bind(1, app.id);
  stmt.Bind(2, app.name);
  stmt.Bind(3, app.path);
  stmt.Bind(4, app.iconPath);
  stmt.Bind(5, app.position);
  stmt.Bind(6, app.isPinned ? 1 : 0);
  
  return stmt.Step();
}
```

## 性能优化

### 1. 索引策略

- 为频繁查询的列创建索引
- 为外键创建索引
- 为排序字段创建索引
- 避免过度索引（影响写入性能）

### 2. 查询优化

```sql
-- 使用 EXPLAIN QUERY PLAN 分析查询
EXPLAIN QUERY PLAN
SELECT * FROM wallpapers WHERE type = 'video';

-- 优化：使用覆盖索引
CREATE INDEX idx_wallpapers_type_created 
ON wallpapers(type, created_at DESC);
```

### 3. WAL 模式

```sql
-- Write-Ahead Logging: 提高并发性能
PRAGMA journal_mode = WAL;

-- 定期 checkpoint
PRAGMA wal_checkpoint(TRUNCATE);
```

### 4. 批量操作

```cpp
// 批量插入：使用事务
void BulkInsertWallpapers(const std::vector<Wallpaper>& wallpapers) {
  auto& db = Database::Instance();
  auto tx = db.BeginTransaction();
  
  auto stmt = db.Prepare(
    "INSERT INTO wallpapers (...) VALUES (?, ?, ...)"
  );
  
  for (const auto& wp : wallpapers) {
    stmt.Bind(1, wp.id);
    stmt.Bind(2, wp.name);
    // ...
    stmt.Step();
    stmt.Reset();
  }
  
  tx.Commit();
}
```

## 备份与恢复

### 自动备份

```cpp
// src/core/BackupManager.h
class BackupManager {
public:
  static bool CreateBackup(const std::string& backupPath);
  static bool RestoreBackup(const std::string& backupPath);
  static void StartAutoBackup(int intervalHours);
  static void StopAutoBackup();
  
  static std::vector<BackupInfo> ListBackups();
  static bool DeleteOldBackups(int keepDays);
};

// 实现
bool BackupManager::CreateBackup(const std::string& backupPath) {
  auto& db = Database::Instance();
  
  // SQLite 在线备份 API
  sqlite3* pBackup;
  int rc = sqlite3_open(backupPath.c_str(), &pBackup);
  if (rc != SQLITE_OK) {
    return false;
  }
  
  sqlite3_backup* pBackupHandle = sqlite3_backup_init(
    pBackup, "main",
    db.GetHandle(), "main"
  );
  
  if (pBackupHandle) {
    sqlite3_backup_step(pBackupHandle, -1);
    sqlite3_backup_finish(pBackupHandle);
  }
  
  sqlite3_close(pBackup);
  
  spdlog::info("Database backup created: {}", backupPath);
  return true;
}
```

---

*数据库设计将根据功能需求持续演进*

