# 构建与部署文档

## 构建流程概览

```
Source Code
    │
    ├─> Frontend Build (npm run build)
    │   └─> resources/web/
    │
    └─> Backend Build (CMake)
        │
        ├─> Compile C++
        ├─> Link Libraries
        └─> bin/CodeCanvas.exe
            │
            └─> Packaging
                └─> dist/CodeCanvas-1.0.0-Setup.exe
```

## 前端构建

### 开发构建

```powershell
cd frontend

# 安装依赖（首次）
npm install

# 开发模式（热重载）
npm run dev
# 访问 http://localhost:5173

# 代码检查
npm run lint

# 代码格式化
npm run format
```

### 生产构建

```powershell
cd frontend

# TypeScript 类型检查 + 构建
npm run build

# 输出目录：../resources/web/
# ├── index.html
# ├── assets/
# │   ├── index-[hash].js
# │   ├── index-[hash].css
# │   └── ...
# └── favicon.ico
```

### 构建配置

**vite.config.ts**（关键配置）：
```typescript
export default defineConfig({
  base: './',  // 相对路径，适配 WebView2
  
  build: {
    outDir: '../resources/web',
    emptyOutDir: true,
    
    // 代码分割
    rollupOptions: {
      output: {
        manualChunks: {
          'vue-vendor': ['vue', 'pinia', 'vue-router'],
          'animation': ['gsap']
        },
        // 文件命名
        entryFileNames: 'assets/[name]-[hash].js',
        chunkFileNames: 'assets/[name]-[hash].js',
        assetFileNames: 'assets/[name]-[hash].[ext]'
      }
    },
    
    // 压缩
    minify: 'terser',
    terserOptions: {
      compress: {
        drop_console: true,  // 移除 console.log
        drop_debugger: true
      }
    },
    
    // 优化
    cssCodeSplit: true,
    sourcemap: false,  // 生产环境不生成 sourcemap
    
    // 资源内联限制
    assetsInlineLimit: 4096  // 4KB
  }
})
```

### 构建优化

#### Tree Shaking

```typescript
// 只导入需要的模块
import { ref, computed } from 'vue'  // ✅ Good
import Vue from 'vue'                 // ❌ Bad
```

#### 动态导入

```typescript
// 路由懒加载
const routes = [
  {
    path: '/settings',
    component: () => import('@/views/Settings.vue')
  }
]

// 组件懒加载
const HeavyComponent = defineAsyncComponent(() =>
  import('@/components/HeavyComponent.vue')
)
```

## 后端构建

### CMake 配置

#### 生成构建文件

```powershell
# 创建构建目录
mkdir build
cd build

# 生成 Visual Studio 项目
cmake .. -G "Visual Studio 17 2022" -A x64

# 或生成 Ninja 项目（更快）
cmake .. -G "Ninja" -DCMAKE_BUILD_TYPE=Release
```

#### CMake 选项

```powershell
# 指定 vcpkg
cmake .. -DCMAKE_TOOLCHAIN_FILE=C:/vcpkg/scripts/buildsystems/vcpkg.cmake

# 指定构建类型
cmake .. -DCMAKE_BUILD_TYPE=Release

# 启用测试
cmake .. -DBUILD_TESTING=ON

# 自定义安装路径
cmake .. -DCMAKE_INSTALL_PREFIX=C:/CodeCanvas
```

### 编译

#### Debug 构建

```powershell
cd build
cmake --build . --config Debug

# 输出：build/Debug/CodeCanvas.exe
```

#### Release 构建

```powershell
cd build
cmake --build . --config Release

# 输出：build/Release/CodeCanvas.exe
```

#### 并行编译

```powershell
# 使用多核编译（加速）
cmake --build . --config Release --parallel 8

# 或
cmake --build . --config Release -- /maxcpucount:8
```

### 编译优化

#### CMakeLists.txt 优化配置

```cmake
# Release 模式优化
if(CMAKE_BUILD_TYPE STREQUAL "Release")
  # MSVC 优化
  if(MSVC)
    target_compile_options(${PROJECT_NAME} PRIVATE
      /O2          # 最大优化（速度）
      /Ob2         # 内联展开
      /Oi          # 内置函数
      /Ot          # 偏向速度
      /GL          # 全程序优化
      /fp:fast     # 快速浮点
    )
    
    target_link_options(${PROJECT_NAME} PRIVATE
      /LTCG        # 链接时代码生成
      /OPT:REF     # 移除未引用代码
      /OPT:ICF     # 合并相同代码
    )
  endif()
  
  # 移除调试信息
  target_compile_definitions(${PROJECT_NAME} PRIVATE
    NDEBUG
    _RELEASE
  )
endif()

# Debug 模式配置
if(CMAKE_BUILD_TYPE STREQUAL "Debug")
  if(MSVC)
    target_compile_options(${PROJECT_NAME} PRIVATE
      /Od          # 禁用优化
      /Zi          # 完整调试信息
      /RTC1        # 运行时检查
    )
  endif()
  
  target_compile_definitions(${PROJECT_NAME} PRIVATE
    _DEBUG
    DEBUG_BUILD
  )
endif()
```

### 增量构建

```powershell
# 只编译修改的文件
cmake --build . --config Release

# 强制完全重新构建
cmake --build . --config Release --clean-first
```

## 资源处理

### 图标和资源

#### 应用图标

**app.rc**（资源脚本）：
```rc
#include <windows.h>

// 应用图标
IDI_ICON1 ICON "resources/icons/app.ico"

// 版本信息
VS_VERSION_INFO VERSIONINFO
FILEVERSION     1,0,0,0
PRODUCTVERSION  1,0,0,0
BEGIN
  BLOCK "StringFileInfo"
  BEGIN
    BLOCK "040904B0"
    BEGIN
      VALUE "CompanyName", "CodeCanvas Team"
      VALUE "FileDescription", "CodeCanvas Desktop Beautifier"
      VALUE "FileVersion", "1.0.0"
      VALUE "InternalName", "CodeCanvas"
      VALUE "LegalCopyright", "Copyright (C) 2025"
      VALUE "OriginalFilename", "CodeCanvas.exe"
      VALUE "ProductName", "CodeCanvas"
      VALUE "ProductVersion", "1.0.0"
    END
  END
  BLOCK "VarFileInfo"
  BEGIN
    VALUE "Translation", 0x409, 1200
  END
END
```

**CMakeLists.txt**：
```cmake
# 添加资源文件
target_sources(${PROJECT_NAME} PRIVATE
  ${CMAKE_CURRENT_SOURCE_DIR}/resources/app.rc
)
```

### 资源复制

```cmake
# 安装资源
install(TARGETS ${PROJECT_NAME} DESTINATION bin)

install(DIRECTORY ${CMAKE_CURRENT_SOURCE_DIR}/resources/
  DESTINATION resources
  PATTERN "*.psd" EXCLUDE      # 排除 PSD 源文件
  PATTERN "*.ai" EXCLUDE
  PATTERN ".DS_Store" EXCLUDE
)

# 复制 WebView2 运行时
install(FILES ${CMAKE_CURRENT_SOURCE_DIR}/libs/WebView2Loader.dll
  DESTINATION bin
)

# 复制前端构建产物（已在前端构建时生成）
install(DIRECTORY ${CMAKE_CURRENT_SOURCE_DIR}/resources/web/
  DESTINATION resources/web
)
```

## 打包

### 安装包制作

使用 **Inno Setup** 或 **WiX Toolset**

#### Inno Setup（推荐，简单）

**setup.iss**：
```ini
#define MyAppName "CodeCanvas"
#define MyAppVersion "1.0.0"
#define MyAppPublisher "CodeCanvas Team"
#define MyAppURL "https://codecanvas.example.com"
#define MyAppExeName "CodeCanvas.exe"

[Setup]
AppId={{YOUR-GUID-HERE}}
AppName={#MyAppName}
AppVersion={#MyAppVersion}
AppPublisher={#MyAppPublisher}
AppPublisherURL={#MyAppURL}
AppSupportURL={#MyAppURL}
AppUpdatesURL={#MyAppURL}
DefaultDirName={autopf}\{#MyAppName}
DefaultGroupName={#MyAppName}
AllowNoIcons=yes
LicenseFile=LICENSE.txt
OutputDir=dist
OutputBaseFilename=CodeCanvas-{#MyAppVersion}-Setup
Compression=lzma2/ultra64
SolidCompression=yes
WizardStyle=modern
ArchitecturesAllowed=x64
ArchitecturesInstallIn64BitMode=x64
PrivilegesRequired=admin
UninstallDisplayIcon={app}\{#MyAppExeName}

[Languages]
Name: "english"; MessagesFile: "compiler:Default.isl"
Name: "chinesesimplified"; MessagesFile: "compiler:Languages\ChineseSimplified.isl"

[Tasks]
Name: "desktopicon"; Description: "{cm:CreateDesktopIcon}"; GroupDescription: "{cm:AdditionalIcons}"
Name: "startup"; Description: "开机启动"; GroupDescription: "其他选项:"

[Files]
Source: "build\Release\{#MyAppExeName}"; DestDir: "{app}"; Flags: ignoreversion
Source: "build\Release\*.dll"; DestDir: "{app}"; Flags: ignoreversion
Source: "resources\*"; DestDir: "{app}\resources"; Flags: ignoreversion recursesubdirs createallsubdirs

[Icons]
Name: "{group}\{#MyAppName}"; Filename: "{app}\{#MyAppExeName}"
Name: "{group}\{cm:UninstallProgram,{#MyAppName}}"; Filename: "{uninstallexe}"
Name: "{autodesktop}\{#MyAppName}"; Filename: "{app}\{#MyAppExeName}"; Tasks: desktopicon

[Run]
Filename: "{app}\{#MyAppExeName}"; Description: "{cm:LaunchProgram,{#MyAppName}}"; Flags: nowait postinstall skipifsilent

[Registry]
Root: HKCU; Subkey: "Software\Microsoft\Windows\CurrentVersion\Run"; ValueType: string; ValueName: "CodeCanvas"; ValueData: """{app}\{#MyAppExeName}"""; Flags: uninsdeletevalue; Tasks: startup

[Code]
// 检查 .NET Framework / VC++ Redistributable
function InitializeSetup(): Boolean;
begin
  Result := True;
  // 添加依赖检查逻辑
end;
```

**构建安装包**：
```powershell
# 安装 Inno Setup
winget install JRSoftware.InnoSetup

# 编译安装脚本
iscc setup.iss

# 输出：dist/CodeCanvas-1.0.0-Setup.exe
```

### 绿色版打包

```powershell
# scripts/package-portable.ps1

$version = "1.0.0"
$outDir = "dist/CodeCanvas-$version-Portable"

# 创建目录结构
New-Item -ItemType Directory -Force -Path $outDir
New-Item -ItemType Directory -Force -Path "$outDir/resources"

# 复制文件
Copy-Item "build/Release/CodeCanvas.exe" "$outDir/"
Copy-Item "build/Release/*.dll" "$outDir/"
Copy-Item -Recurse "resources/*" "$outDir/resources/"

# 创建配置文件（标记为绿色版）
@"
{
  "portable": true,
  "dataDir": "./data"
}
"@ | Out-File -Encoding UTF8 "$outDir/config.json"

# 压缩
Compress-Archive -Path "$outDir/*" -DestinationPath "dist/CodeCanvas-$version-Portable.zip"

Write-Host "绿色版打包完成: dist/CodeCanvas-$version-Portable.zip"
```

## 代码签名

### 获取代码签名证书

1. 购买 **EV 代码签名证书**（推荐）
2. 或使用自签名证书（测试）

### 签名工具

```powershell
# 使用 signtool（Windows SDK）
$signtool = "C:\Program Files (x86)\Windows Kits\10\bin\10.0.22621.0\x64\signtool.exe"

# 签名 EXE
& $signtool sign /f "cert.pfx" /p "password" /t http://timestamp.digicert.com /v "CodeCanvas.exe"

# 签名安装包
& $signtool sign /f "cert.pfx" /p "password" /t http://timestamp.digicert.com /v "CodeCanvas-1.0.0-Setup.exe"
```

### 自动签名脚本

```powershell
# scripts/sign.ps1

param(
  [string]$CertFile = "cert.pfx",
  [string]$Password = $env:CERT_PASSWORD,
  [string]$Target
)

$signtool = "C:\Program Files (x86)\Windows Kits\10\bin\10.0.22621.0\x64\signtool.exe"

if (-not (Test-Path $CertFile)) {
  Write-Error "证书文件不存在: $CertFile"
  exit 1
}

Write-Host "签名文件: $Target"

& $signtool sign `
  /f $CertFile `
  /p $Password `
  /t http://timestamp.digicert.com `
  /fd SHA256 `
  /v `
  $Target

if ($LASTEXITCODE -ne 0) {
  Write-Error "签名失败"
  exit 1
}

Write-Host "签名成功"
```

## 完整构建脚本

### Windows PowerShell

```powershell
# scripts/build-release.ps1

param(
  [string]$Version = "1.0.0",
  [switch]$Clean,
  [switch]$Sign
)

$ErrorActionPreference = "Stop"

Write-Host "=== CodeCanvas 完整构建 ===" -ForegroundColor Cyan
Write-Host "版本: $Version"

# 1. 清理
if ($Clean) {
  Write-Host "`n[1/5] 清理旧构建..." -ForegroundColor Yellow
  Remove-Item -Recurse -Force -ErrorAction SilentlyContinue build, dist
}

# 2. 构建前端
Write-Host "`n[2/5] 构建前端..." -ForegroundColor Yellow
Set-Location frontend
npm install
npm run build
if ($LASTEXITCODE -ne 0) { exit 1 }
Set-Location ..

# 3. 构建后端
Write-Host "`n[3/5] 构建后端..." -ForegroundColor Yellow
New-Item -ItemType Directory -Force -Path build | Out-Null
Set-Location build

cmake .. -G "Visual Studio 17 2022" -A x64 `
  -DCMAKE_TOOLCHAIN_FILE="$env:VCPKG_ROOT/scripts/buildsystems/vcpkg.cmake"
if ($LASTEXITCODE -ne 0) { exit 1 }

cmake --build . --config Release --parallel 8
if ($LASTEXITCODE -ne 0) { exit 1 }
Set-Location ..

# 4. 代码签名（可选）
if ($Sign) {
  Write-Host "`n[4/5] 代码签名..." -ForegroundColor Yellow
  .\scripts\sign.ps1 -Target "build\Release\CodeCanvas.exe"
}

# 5. 打包
Write-Host "`n[5/5] 制作安装包..." -ForegroundColor Yellow

# 更新版本号
(Get-Content setup.iss) -replace '#define MyAppVersion ".*"', "#define MyAppVersion `"$Version`"" | 
  Set-Content setup.iss

# 编译安装包
iscc setup.iss
if ($LASTEXITCODE -ne 0) { exit 1 }

# 签名安装包
if ($Sign) {
  .\scripts\sign.ps1 -Target "dist\CodeCanvas-$Version-Setup.exe"
}

# 制作绿色版
.\scripts\package-portable.ps1

Write-Host "`n=== 构建完成 ===" -ForegroundColor Green
Write-Host "安装包: dist/CodeCanvas-$Version-Setup.exe"
Write-Host "绿色版: dist/CodeCanvas-$Version-Portable.zip"
Write-Host "大小:"
Get-ChildItem dist/*.exe, dist/*.zip | ForEach-Object {
  $size = [math]::Round($_.Length / 1MB, 2)
  Write-Host "  $($_.Name): $size MB"
}
```

### 使用

```powershell
# 完整构建
.\scripts\build-release.ps1 -Version "1.0.0" -Clean

# 带签名构建
.\scripts\build-release.ps1 -Version "1.0.0" -Clean -Sign

# 增量构建
.\scripts\build-release.ps1
```

## CI/CD 集成

### GitHub Actions

**.github/workflows/build.yml**：
```yaml
name: Build

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  release:
    types: [ created ]

jobs:
  build:
    runs-on: windows-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: 18
    
    - name: Setup vcpkg
      run: |
        git clone https://github.com/microsoft/vcpkg.git C:\vcpkg
        C:\vcpkg\bootstrap-vcpkg.bat
        C:\vcpkg\vcpkg integrate install
      
    - name: Install dependencies
      run: |
        C:\vcpkg\vcpkg install nlohmann-json:x64-windows spdlog:x64-windows sqlite3:x64-windows
    
    - name: Build Frontend
      run: |
        cd frontend
        npm install
        npm run build
    
    - name: Build Backend
      run: |
        mkdir build
        cd build
        cmake .. -G "Visual Studio 17 2022" -A x64 -DCMAKE_TOOLCHAIN_FILE=C:/vcpkg/scripts/buildsystems/vcpkg.cmake
        cmake --build . --config Release
    
    - name: Package
      run: |
        powershell -File scripts/build-release.ps1 -Version ${{ github.ref_name }}
    
    - name: Upload Artifacts
      uses: actions/upload-artifact@v3
      with:
        name: CodeCanvas-${{ github.ref_name }}
        path: dist/*
    
    - name: Release
      if: github.event_name == 'release'
      uses: softprops/action-gh-release@v1
      with:
        files: |
          dist/CodeCanvas-*.exe
          dist/CodeCanvas-*.zip
```

## 版本管理

### 语义化版本

```
v{major}.{minor}.{patch}[-{pre-release}][+{build}]

示例:
v1.0.0
v1.0.0-beta.1
v1.0.0+20231101
```

### 版本号同步

**scripts/update-version.ps1**：
```powershell
param([string]$Version)

# 更新 CMakeLists.txt
$cmake = Get-Content CMakeLists.txt
$cmake -replace 'project\(CodeCanvas VERSION [\d.]+', "project(CodeCanvas VERSION $Version" |
  Set-Content CMakeLists.txt

# 更新 package.json
$package = Get-Content frontend/package.json | ConvertFrom-Json
$package.version = $Version
$package | ConvertTo-Json -Depth 10 | Set-Content frontend/package.json

# 更新 setup.iss
$setup = Get-Content setup.iss
$setup -replace '#define MyAppVersion ".*"', "#define MyAppVersion `"$Version`"" |
  Set-Content setup.iss

Write-Host "版本号已更新为: $Version"
```

## 发布检查清单

- [ ] 代码已合并到 `main` 分支
- [ ] 版本号已更新
- [ ] Changelog 已更新
- [ ] 所有测试通过
- [ ] 性能测试通过
- [ ] 代码已签名
- [ ] 安装包测试通过
- [ ] 文档已更新
- [ ] Release Notes 已准备

---

*构建流程将随着项目发展持续优化*

